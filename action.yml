# action.yml
name: 'Gemini AI PR Review'
description: 'A reusable GitHub Action for automated PR reviews using the Gemini API.'

inputs:
  gemini-api-key:
    description: 'The Gemini API key to authenticate with the API.'
    required: true
  review-diff-limit:
    description: 'The maximum character count for the diff content to be sent to Gemini.'
    required: false
    default: '8000'
  review-prompt:
    description: 'The custom prompt for the Gemini AI reviewer.'
    required: false
    default: |
      You are an expert code reviewer. Please review the following pull request changes and provide a detailed analysis. Your review should be constructive and specific, and formatted in markdown.

      Provide the following sections:
      1. **Code Quality Assessment**: Rate the overall code quality (1-10) and explain your reasoning.
      2. **Security Analysis**: Identify any potential security vulnerabilities or concerns.
      3. **Performance Review**: Comment on performance implications of the changes.
      4. **Best Practices**: Note any deviations from coding best practices and provide suggestions.
      5. **Suggestions**: Provide specific, actionable improvement suggestions.
      6. **Resources**: Include relevant documentation links or learning resources when applicable.

      **Pull Request Title**: {{ pr_title }}
      **Pull Request Description**: {{ pr_body }}
      **Changed Files**: {{ changed_files }}

      **Code Changes**:
      ```diff
      {{ diff_content }}
      ```

runs:
  using: "composite"
  steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get Changed Files and Diff
      id: get-diff
      shell: bash
      run: |
        # Get list of changed files
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | tr '\n' ' ')

        # Get the diff content, respecting the size limit
        DIFF_CONTENT=$(git diff --unified=3 ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | head -c ${{ inputs.review-diff-limit }})

        # Escape the diff for JSON and prepare the full prompt
        # Replace placeholders in the prompt with actual PR data and diff
        ESCAPED_PROMPT=$(echo "${{ inputs.review-prompt }}" | \
          sed -e 's|{{ pr_title }}|${{ github.event.pull_request.title }}|g' \
              -e 's|{{ pr_body }}|${{ github.event.pull_request.body }}|g' \
              -e 's|{{ changed_files }}|${CHANGED_FILES}|g' \
              -e 's|{{ diff_content }}|'"`echo "$DIFF_CONTENT" | sed 's/"/\\"/g' | tr '\n' ' '`"'|g')

        echo "escaped_prompt=${ESCAPED_PROMPT}" >> $GITHUB_ENV
        echo "files_list=${CHANGED_FILES}" >> $GITHUB_OUTPUT

    - name: Call Gemini API
      id: gemini-api
      shell: bash
      run: |
        RESPONSE=$(curl -s -X POST \
          "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${{ inputs.gemini-api-key }}" \
          -H "Content-Type: application/json" \
          -d '{
            "contents": [{
              "parts": [{
                "text": "'"$(echo "$ESCAPED_PROMPT" | tr '\n' ' ')"'"
              }]
            }],
            "generationConfig": {
              "temperature": 0.1,
              "maxOutputTokens": 2048
            }
          }')

        # Extract review text from JSON response using jq
        REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Failed to generate review"')

        echo "review_content=$(echo "$REVIEW_TEXT" | sed -e 's/%/\%25/g' -e 's/\n/%0A/g' -e 's/\r/%0D/g')" >> $GITHUB_OUTPUT

    - name: Post Review Comment
      if: success()
      uses: actions/github-script@v7
      with:
        github-token: ${{ github.token }}
        script: |
          const reviewContent = decodeURIComponent('${{ steps.gemini-api.outputs.review_content }}');
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ¤– Gemini AI Code Review\n\n${reviewContent}\n\n---\n*This review was automatically generated by Gemini AI. Please consider this feedback alongside human review.*`
          });

    - name: Add 'ai-reviewed' Label
      uses: actions/github-script@v7
      with:
        github-token: ${{ github.token }}
        script: |
          await github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['ai-reviewed']
          });